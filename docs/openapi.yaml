openapi: 3.1.0
info:
  title: TFF Shipping API
  version: 1.0.0
  description: >
    Use this API to:
      1) request shipping options (rates)
      2) create a shipment (labels/documents) using a previously selected option

    Notes:
      - If input data is incomplete/invalid, the API returns HTTP 422 with field-level details.
      - For some destinations (US/CA/AU), a region/state is required.

servers:
  - url: https://api.inset.example
    description: Production (replace)
  - url: https://sandbox.api.inset.example
    description: Sandbox (replace)

tags:
  - name: Rates
  - name: Shipments
  - name: Documents

security: [] # per-endpoint

components:
  securitySchemes:
    FrontendKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Key used by frontend (public flow) to request rates.

    BackendKeyAuth:
      type: apiKey
      in: header
      name: X-Backend-Key
      description: Key used by backend/admin systems to create shipments and fetch documents.

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      description: >
        Unique key for this shipment request. If the same request is sent again with the same key,
        the API will not create duplicate shipments.
      schema:
        type: string
        minLength: 8
        maxLength: 200

  schemas:
    # -----------------------------
    # Errors (simple + consistent)
    # -----------------------------
    ErrorCode:
      type: string
      enum:
        - VALIDATION_ERROR
        - CUSTOMS_REQUIRED
        - NO_SERVICES_AVAILABLE
        - TEMPORARY_UNAVAILABLE
        - TIMEOUT
        - UNAUTHORIZED
        - RATE_LIMITED
        - CONFLICT
        - INTERNAL_ERROR
        - SELECTION_EXPIRED
        - SELECTION_MISMATCH

    ErrorDetail:
      type: object
      additionalProperties: false
      properties:
        path:
          type: string
          description: Field location (e.g. "recipient.postalCode", "packages[0].weight").
        reason:
          type: string
          description: Machine-readable reason (required/invalid_format/out_of_range/etc.).
        message:
          type: string
          description: Optional extra detail (often includes an example format).
      required: [path, reason]

    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        error:
          type: object
          additionalProperties: false
          properties:
            code: { $ref: "#/components/schemas/ErrorCode" }
            message:
              type: string
              description: Human-readable message safe to display to end users.
            retryable:
              type: boolean
              description: Whether retrying later can help.
            requestId:
              type: string
              description: Reference for support/troubleshooting.
            details:
              type: array
              items: { $ref: "#/components/schemas/ErrorDetail" }
          required: [code, message, retryable, requestId]
      required: [error]

    # -----------------------------
    # Inputs
    # -----------------------------
    AddressRatesInput:
      type: object
      additionalProperties: false
      description: >
        Minimum address data needed to calculate rates.
        Region/state is required for US/CA/AU.
      properties:
        country:
          type: string
          minLength: 2
          maxLength: 2
          description: ISO 3166-1 alpha-2 (e.g. "NL", "DE", "US").
        postalCode:
          type: string
          maxLength: 16
        city:
          type: string
          maxLength: 35
        street:
          type: string
          maxLength: 35
          description: Street name (without house number).
        houseNumber:
          type: string
          maxLength: 35
          description: House number/addition. If unknown, you may leave it empty.
        region:
          type: string
          maxLength: 35
          description: State/Province/Region (required for US/CA/AU).
        company:
          type: string
          maxLength: 35
          description: Optional.
      required: [country, postalCode, city, street]

    AddressShipmentInput:
      type: object
      additionalProperties: false
      description: >
        Address data for shipment creation.
        Region/state is required for US/CA/AU.
      properties:
        company:
          type: string
          maxLength: 35
          description: Optional. Leave empty for private recipients.
        firstName:
          type: string
          maxLength: 35
        lastName:
          type: string
          maxLength: 35
        email:
          type: string
          description: Optional (but recommended).
        phoneNumber:
          type: string
          maxLength: 32
        country:
          type: string
          minLength: 2
          maxLength: 2
        postalCode:
          type: string
          maxLength: 16
        city:
          type: string
          maxLength: 35
        street:
          type: string
          maxLength: 35
        houseNumber:
          type: string
          maxLength: 35
          description: If unknown, you may leave it empty.
        region:
          type: string
          maxLength: 35
          description: State/Province/Region (required for US/CA/AU).
      required:
        - firstName
        - lastName
        - phoneNumber
        - country
        - postalCode
        - city
        - street

    PackageInput:
      type: object
      additionalProperties: false
      description: Package dimensions in cm and weight in kg.
      properties:
        type:
          type: string
          enum: [package, pallet, document]
        length:
          type: number
          minimum: 1
        width:
          type: number
          minimum: 1
        height:
          type: number
          minimum: 1
        weight:
          type: number
          minimum: 0.01
        stackable:
          type: boolean
          default: false
      required: [type, length, width, height, weight]

    TruckOptions:
      type: object
      additionalProperties: false
      description: Optional extra handling options (defaults to false).
      properties:
        shipperForklift: { type: boolean, default: false }
        shipperTailLift: { type: boolean, default: false }
        recipientForklift: { type: boolean, default: false }
        recipientTailLift: { type: boolean, default: false }

    RequestContext:
      type: string
      enum: [customer, admin]
      description: >
        customer: end-user flow (e.g. webshop checkout)
        admin: backoffice/admin flow

    QuoteRequest:
      type: object
      additionalProperties: false
      properties:
        context: { $ref: "#/components/schemas/RequestContext" }
        shipper: { $ref: "#/components/schemas/AddressRatesInput" }
        recipient: { $ref: "#/components/schemas/AddressRatesInput" }
        packages:
          type: array
          minItems: 1
          items: { $ref: "#/components/schemas/PackageInput" }
        truckOptions:
          $ref: "#/components/schemas/TruckOptions"
      required: [context, shipper, recipient, packages]

    # -----------------------------
    # Rates output
    # -----------------------------
    AccessPoint:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        name: { type: string }
        address: { type: string }
        city: { type: string }
        postalCode: { type: string }
        country: { type: string, minLength: 2, maxLength: 2 }
      required: [id, name, address, city, postalCode, country]

    PickupDate:
      type: object
      additionalProperties: false
      properties:
        date: { type: string, format: date }
        transitTime: { type: string }

    Rate:
      type: object
      additionalProperties: false
      description: >
        Shipping option you can show to the user.
        To create a shipment later, store quoteId + rateId + rateToken.
      properties:
        quoteId: { type: string }
        rateId: { type: string }
        serviceId:
          type: string
          description: Stable service identifier.
        carrier: { type: string }
        service: { type: string }
        serviceDescription: { type: string }
        price:
          type: string
          description: Decimal string (e.g. "12.34").
        imgUrl: { type: string }
        transitTime: { type: string }
        pickupDate: { type: string, format: date }
        pickupTime: { type: string }
        deliveryDate: { type: string, format: date }
        deliveryTime: { type: string }
        carbonNeutral: { type: boolean }
        availablePickupDates:
          type: array
          items: { $ref: "#/components/schemas/PickupDate" }
        noPickupPossible: { type: boolean }
        accessPoints:
          type: array
          items: { $ref: "#/components/schemas/AccessPoint" }
        rateToken:
          type: string
          description: Opaque token needed to create the shipment later (store and replay as-is).
      required: [quoteId, rateId, serviceId, carrier, service, price, rateToken]

    QuoteWarning:
      type: object
      additionalProperties: false
      properties:
        code:
          type: string
          enum: [CHECKOUT_FALLBACK, PARTIAL_RESULTS]
        message: { type: string }
      required: [code, message]

    QuoteResponse:
      type: object
      additionalProperties: false
      properties:
        requestId: { type: string }
        quoteId: { type: string }
        expiresAt:
          type: string
          format: date-time
          description: If expired, request a new quote.
        rates:
          type: array
          items: { $ref: "#/components/schemas/Rate" }
        warnings:
          type: array
          items: { $ref: "#/components/schemas/QuoteWarning" }
      required: [requestId, quoteId, expiresAt, rates]

    # -----------------------------
    # Shipment creation
    # -----------------------------
    Incoterm:
      type: string
      enum: [DAP, DPU, DDP]

    ExportReason:
      type: string
      enum: [sale, retour, "retour after repair", personal, sample, gift]

    SignatureRequired:
      type: string
      enum: [direct, no_preference, adult, none]

    RegistrationInfo:
      type: object
      additionalProperties: false
      description: >
        Registration details used for customs/export shipments.
        If required but missing, the API returns 422 CUSTOMS_REQUIRED.
      properties:
        shipperType:
          type: string
          description: Example values "EORI", "VAT", "OTHER" (depends on destination).
        shipperNumber: { type: string }
        recipientType:
          type: string
          description: Example values "EIN", "EORI", "VAT", "OTHER" (depends on destination).
        recipientNumber: { type: string }
      required: [shipperType, shipperNumber, recipientType, recipientNumber]

    InvoiceFile:
      type: object
      additionalProperties: false
      properties:
        filename: { type: string }
        base64:
          type: string
          description: Base64-encoded invoice file (no data prefix).
      required: []

    SelectedRate:
      type: object
      additionalProperties: false
      description: The rate chosen earlier (store from the quote response).
      properties:
        quoteId: { type: string }
        rateId: { type: string }
        rateToken: { type: string }
      required: [quoteId, rateId, rateToken]

    ShippingOptions:
      type: object
      additionalProperties: false
      properties:
        incoterm: { $ref: "#/components/schemas/Incoterm" }
        exportReason: { $ref: "#/components/schemas/ExportReason" }
        originCountry:
          type: string
          minLength: 2
          maxLength: 2
          description: ISO 3166-1 alpha-2
        description:
          type: string
          maxLength: 35
          description: Short contents description.
        totalValue:
          type: number
          minimum: 0
          description: Total shipment value (for customs/export).
        signatureRequired: { $ref: "#/components/schemas/SignatureRequired" }
        deliveryInstructions:
          type: string
          maxLength: 15
          description: Optional short instructions.
        insuranceValue:
          type: number
          minimum: 0
          description: Optional.
        pickupPointId:
          type: string
          description: Optional. Use when an access point was chosen.
        registration:
          $ref: "#/components/schemas/RegistrationInfo"
      required: [incoterm, exportReason, originCountry, description, totalValue, signatureRequired]

    ShipmentCreateRequest:
      type: object
      additionalProperties: false
      properties:
        reference:
          type: string
          description: Your unique reference for this shipment (e.g. an order number).
        shipper: { $ref: "#/components/schemas/AddressShipmentInput" }
        recipient: { $ref: "#/components/schemas/AddressShipmentInput" }
        packages:
          type: array
          minItems: 1
          items: { $ref: "#/components/schemas/PackageInput" }
        selectedRate: { $ref: "#/components/schemas/SelectedRate" }
        shippingOptions: { $ref: "#/components/schemas/ShippingOptions" }
        invoice: { $ref: "#/components/schemas/InvoiceFile" }
      required: [reference, shipper, recipient, packages, selectedRate, shippingOptions]

    ShipmentStatus:
      type: string
      enum: [READY, PROCESSING, FAILED, CANCELED]

    DocumentType:
      type: string
      enum: [LABEL, COMMERCIAL_INVOICE, CN23, OTHER]

    DocumentFormat:
      type: string
      enum: [PDF, PNG]

    DocumentRef:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        type: { $ref: "#/components/schemas/DocumentType" }
        format: { $ref: "#/components/schemas/DocumentFormat" }
        url:
          type: string
          format: uri
          description: Download URL.
        expiresAt: { type: string, format: date-time }
      required: [id, type, format, url]

    ShipmentResponse:
      type: object
      additionalProperties: false
      properties:
        requestId: { type: string }
        shipmentId: { type: string }
        status: { $ref: "#/components/schemas/ShipmentStatus" }
        trackingNumbers:
          type: array
          items: { type: string }
        documents:
          type: array
          items: { $ref: "#/components/schemas/DocumentRef" }
      required: [requestId, shipmentId, status, documents]

    CancelShipmentResponse:
      type: object
      additionalProperties: false
      properties:
        requestId: { type: string }
        shipmentId: { type: string }
        status: { $ref: "#/components/schemas/ShipmentStatus" }
      required: [requestId, shipmentId, status]

paths:
  /v1/rates/quote:
    post:
      tags: [Rates]
      operationId: quoteRates
      summary: Get shipping options (rates)
      description: >
        Returns a list of shipping options for the given addresses and packages.

        Validation:
          - If a field is missing/invalid, you receive HTTP 422 with details that can be shown to the user.
          - Region/state is required for US/CA/AU.
      security:
        - FrontendKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/QuoteRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/QuoteResponse" }
        "401":
          description: Invalid key
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Missing/invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                invalidPostal:
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: "Some fields are invalid."
                      retryable: false
                      requestId: "req_abc123"
                      details:
                        - path: "recipient.postalCode"
                          reason: "invalid_format"
                          message: "Postal code format is not valid. Example: 1234 AB"
        "429":
          description: Too many requests
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "503":
          description: Temporarily unavailable
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "504":
          description: Timeout
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments:
    post:
      tags: [Shipments]
      operationId: createShipment
      summary: Create a shipment
      description: >
        Creates a shipment using a selected rate from a previous quote.

        Important:
          - If address/package details changed since the quote, the request fails with 422 SELECTION_MISMATCH.
      security:
        - BackendKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ShipmentCreateRequest" }
      responses:
        "201":
          description: Created (READY or PROCESSING)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShipmentResponse" }
        "202":
          description: Accepted (PROCESSING)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShipmentResponse" }
        "401":
          description: Invalid key
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Missing/invalid input, customs required, or selection mismatch/expired
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                selectionMismatch:
                  value:
                    error:
                      code: SELECTION_MISMATCH
                      message: "Shipment details changed since the selected rate. Request a new quote."
                      retryable: false
                      requestId: "req_mm123"
                customsRequired:
                  value:
                    error:
                      code: CUSTOMS_REQUIRED
                      message: "Customs/registration details are required for this shipment."
                      retryable: false
                      requestId: "req_cust123"
        "409":
          description: Conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "503":
          description: Temporarily unavailable
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "504":
          description: Timeout
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments/{shipmentId}:
    get:
      tags: [Shipments]
      operationId: getShipment
      summary: Get shipment details
      description: >
        Returns the current shipment status and any available documents.
        This is mainly used for reprinting/retrieving labels later.
      security:
        - BackendKeyAuth: []
      parameters:
        - name: shipmentId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShipmentResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments/{shipmentId}/documents:
    get:
      tags: [Documents]
      operationId: listDocuments
      summary: List shipment documents
      description: Returns download links for shipment documents (labels, invoices, etc.).
      security:
        - BackendKeyAuth: []
      parameters:
        - name: shipmentId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  requestId: { type: string }
                  shipmentId: { type: string }
                  documents:
                    type: array
                    items: { $ref: "#/components/schemas/DocumentRef" }
                required: [requestId, shipmentId, documents]
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments/{shipmentId}/cancel:
    post:
      tags: [Shipments]
      operationId: cancelShipment
      summary: Cancel a shipment
      description: Cancels a shipment if possible.
      security:
        - BackendKeyAuth: []
      parameters:
        - name: shipmentId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CancelShipmentResponse" }
        "409":
          description: Cannot cancel (already processed/shipped)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
