openapi: 3.1.0
info:
  title: TFF Shipping API
  version: 1.0.0
  description: >
    Use this API to:
      1) request shipping options (rates)
      2) create a shipment (labels/documents) using a previously selected option

    The API returns consistent error messages with a small set of error codes.

servers:
  - url: https://api.inset.example
    description: Production (replace)
  - url: https://sandbox.api.inset.example
    description: Sandbox (replace)

tags:
  - name: Rates
  - name: Shipments
  - name: Documents

security: []   # per-endpoint

components:
  securitySchemes:
    FrontendKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Key used by frontend/checkout to request rates.

    BackendKeyAuth:
      type: apiKey
      in: header
      name: X-Backend-Key
      description: Key used by server/admin/ERP to create shipments and fetch documents.

  parameters:
    XRequestId:
      name: X-Request-Id
      in: header
      required: false
      description: Optional request identifier (useful for troubleshooting).
      schema:
        type: string
        minLength: 1
        maxLength: 128

    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      description: >
        A unique key for this shipment request. If the same request is sent again with the same key,
        the API will not create duplicates.
      schema:
        type: string
        minLength: 8
        maxLength: 200

  headers:
    XRequestId:
      description: Request identifier.
      schema:
        type: string

  schemas:
    # -----------------------------
    # Errors (simple + consistent)
    # -----------------------------
    ErrorCode:
      type: string
      enum:
        - VALIDATION_ERROR
        - INVALID_ADDRESS
        - CUSTOMS_REQUIRED
        - NO_SERVICES_AVAILABLE
        - TEMPORARY_CARRIER_FAILURE
        - UPSTREAM_TIMEOUT
        - AUTH_FAILED
        - RATE_LIMITED
        - CONFLICT
        - UPSTREAM_ERROR
        - INTERNAL_ERROR
        - SELECTION_EXPIRED
        - SELECTION_MISMATCH

    ErrorDetail:
      type: object
      additionalProperties: false
      properties:
        path:
          type: string
          description: Field location (e.g. "recipient.postalCode", "packages[0].weight").
        reason:
          type: string
          description: Machine-readable reason (required/invalid_format/out_of_range/etc.).
        message:
          type: string
          description: Optional extra detail.
      required: [path, reason]

    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        error:
          type: object
          additionalProperties: false
          properties:
            code: { $ref: "#/components/schemas/ErrorCode" }
            message:
              type: string
              description: Human-readable message safe for UI.
            retryable:
              type: boolean
              description: Whether retrying later can help.
            requestId:
              type: string
              description: Reference for support/troubleshooting.
            details:
              type: array
              items: { $ref: "#/components/schemas/ErrorDetail" }
          required: [code, message, retryable, requestId]
      required: [error]

    # -----------------------------
    # Request models
    # -----------------------------
    AddressInput:
      type: object
      additionalProperties: false
      description: >
        Address fields used to calculate rates and create shipments.
        Region is especially important for US/CA addresses.
      properties:
        company:
          type: string
          maxLength: 35
          description: Optional. Leave empty for private recipients.
        firstName:
          type: string
          maxLength: 35
          description: Optional for rates, recommended for shipment creation.
        lastName:
          type: string
          maxLength: 35
          description: Optional for rates, recommended for shipment creation.
        email:
          type: string
          description: Optional for rates, recommended for shipment creation.
        phoneNumber:
          type: string
          maxLength: 32
          description: Optional for rates, recommended for shipment creation.
        street:
          type: string
          maxLength: 35
          description: Street name (without house number).
        houseNumber:
          type: string
          maxLength: 35
          description: House number / addition. If unknown, you may leave it empty.
        city:
          type: string
          maxLength: 35
        region:
          type: string
          maxLength: 35
          description: State/Province/Region. For US/CA shipments this should be provided.
        postalCode:
          type: string
          maxLength: 16
        country:
          type: string
          minLength: 2
          maxLength: 2
          description: ISO 3166-1 alpha-2 (e.g. "NL", "DE", "US").
      required:
        - country
        - postalCode
        - street
        - city

    PackageInput:
      type: object
      additionalProperties: false
      description: >
        Package dimensions in cm and weight in kg.
      properties:
        type:
          type: string
          enum: [package, pallet, document]
        length:
          type: number
          minimum: 1
        width:
          type: number
          minimum: 1
        height:
          type: number
          minimum: 1
        weight:
          type: number
          minimum: 0.01
        stackable:
          type: boolean
          default: false
          description: Optional.
      required: [type, length, width, height, weight]

    TruckOptions:
      type: object
      additionalProperties: false
      description: Optional extra handling options (defaults to false).
      properties:
        shipperForklift: { type: boolean, default: false }
        shipperTailLift: { type: boolean, default: false }
        recipientForklift: { type: boolean, default: false }
        recipientTailLift: { type: boolean, default: false }

    RatesContext:
      type: string
      enum: [checkout, backend]
      description: "checkout is optimized for user-facing flows; backend is for system/admin usage."

    QuoteRequest:
      type: object
      additionalProperties: false
      properties:
        context: { $ref: "#/components/schemas/RatesContext" }
        shipper: { $ref: "#/components/schemas/AddressInput" }
        recipient: { $ref: "#/components/schemas/AddressInput" }
        packages:
          type: array
          minItems: 1
          items: { $ref: "#/components/schemas/PackageInput" }
        truckOptions:
          $ref: "#/components/schemas/TruckOptions"
      required: [context, shipper, recipient, packages]

    # -----------------------------
    # Rates response
    # -----------------------------
    AccessPoint:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        name: { type: string }
        address: { type: string }
        city: { type: string }
        postalCode: { type: string }
        country: { type: string, minLength: 2, maxLength: 2 }
      required: [id, name, address, city, postalCode, country]

    PickupDate:
      type: object
      additionalProperties: false
      properties:
        date: { type: string, format: date }
        transitTime: { type: string }

    Rate:
      type: object
      additionalProperties: false
      description: >
        Shipping option you can show to the user.
        To create a shipment later, store quoteId + rateId + rateToken.
      properties:
        quoteId:
          type: string
          description: Quote identifier.
        rateId:
          type: string
          description: Unique rate id inside the quote.
        serviceId:
          type: string
          description: Stable service identifier.
        carrier: { type: string }
        service: { type: string }
        serviceDescription: { type: string }
        price:
          type: string
          description: Decimal string (e.g. "12.34").
        imgUrl: { type: string }
        transitTime: { type: string }
        pickupDate: { type: string, format: date }
        pickupTime: { type: string }
        deliveryDate: { type: string, format: date }
        deliveryTime: { type: string }
        carbonNeutral: { type: boolean }
        availablePickupDates:
          type: array
          items: { $ref: "#/components/schemas/PickupDate" }
        noPickupPossible: { type: boolean }
        accessPoints:
          type: array
          items: { $ref: "#/components/schemas/AccessPoint" }
        rateToken:
          type: string
          description: Opaque token needed to create the shipment later (store and replay as-is).
      required: [quoteId, rateId, serviceId, carrier, service, price, rateToken]

    QuoteWarning:
      type: object
      additionalProperties: false
      properties:
        code:
          type: string
          enum: [CHECKOUT_FALLBACK, PARTIAL_RESULTS]
        message: { type: string }
      required: [code, message]

    QuoteResponse:
      type: object
      additionalProperties: false
      properties:
        quoteId: { type: string }
        expiresAt:
          type: string
          format: date-time
          description: If expired, request a new quote.
        rates:
          type: array
          items: { $ref: "#/components/schemas/Rate" }
        warnings:
          type: array
          items: { $ref: "#/components/schemas/QuoteWarning" }
      required: [quoteId, expiresAt, rates]

    # -----------------------------
    # Shipment creation
    # -----------------------------
    Incoterm:
      type: string
      enum: [DAP, DPU, DDP]

    ExportReason:
      type: string
      enum: [sale, retour, "retour after repair", personal, sample, gift]

    SignatureRequired:
      type: string
      enum: [direct, no_preference, adult, none]

    RegistrationInfo:
      type: object
      additionalProperties: false
      description: Required for export shipments.
      properties:
        shipperType:
          type: string
          description: Example values "EORI", "VAT", "OTHER" (depends on your setup).
        shipperNumber: { type: string }
        recipientType:
          type: string
          description: Example values "EIN", "EORI", "VAT", "OTHER" (depends on destination).
        recipientNumber: { type: string }
      required: [shipperType, shipperNumber, recipientType, recipientNumber]

    InvoiceFile:
      type: object
      additionalProperties: false
      properties:
        filename: { type: string }
        base64:
          type: string
          description: Base64-encoded invoice file (no data: prefix).
      required: []

    ShipmentCreateRequest:
      type: object
      additionalProperties: false
      properties:
        reference:
          type: string
          description: Your unique reference for this shipment (e.g. an order number).
        shipper:
          $ref: "#/components/schemas/AddressInput"
        recipient:
          $ref: "#/components/schemas/AddressInput"
        packages:
          type: array
          minItems: 1
          items: { $ref: "#/components/schemas/PackageInput" }
        selectedRate:
          type: object
          additionalProperties: false
          description: The rate chosen earlier (store from the quote response).
          properties:
            quoteId: { type: string }
            rateId: { type: string }
            rateToken: { type: string }
          required: [quoteId, rateId, rateToken]
        shippingOptions:
          type: object
          additionalProperties: false
          properties:
            incoterm: { $ref: "#/components/schemas/Incoterm" }
            exportReason: { $ref: "#/components/schemas/ExportReason" }
            originCountry:
              type: string
              minLength: 2
              maxLength: 2
              description: ISO 3166-1 alpha-2
            description:
              type: string
              maxLength: 35
              description: Short contents description.
            totalValue:
              type: number
              minimum: 0
              description: Total shipment value (for customs/export).
            deliveryInstructions:
              type: string
              maxLength: 15
              description: Optional short instructions.
            insuranceValue:
              type: number
              minimum: 0
              description: Optional.
            signatureRequired:
              $ref: "#/components/schemas/SignatureRequired"
            registration:
              $ref: "#/components/schemas/RegistrationInfo"
          required: [incoterm, exportReason, originCountry, description, totalValue, signatureRequired]
        invoice:
          $ref: "#/components/schemas/InvoiceFile"
      required: [reference, shipper, recipient, packages, selectedRate, shippingOptions]

    ShipmentStatus:
      type: string
      enum: [READY, PROCESSING, FAILED, CANCELED]

    DocumentType:
      type: string
      enum: [LABEL, COMMERCIAL_INVOICE, CN23, OTHER]

    DocumentFormat:
      type: string
      enum: [PDF, PNG]

    DocumentRef:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        type: { $ref: "#/components/schemas/DocumentType" }
        format: { $ref: "#/components/schemas/DocumentFormat" }
        url:
          type: string
          format: uri
          description: Download URL.
        expiresAt: { type: string, format: date-time }
      required: [id, type, format, url]

    ShipmentResponse:
      type: object
      additionalProperties: false
      properties:
        shipmentId: { type: string }
        status: { $ref: "#/components/schemas/ShipmentStatus" }
        requestId: { type: string }
        trackingNumbers:
          type: array
          items: { type: string }
        documents:
          type: array
          items: { $ref: "#/components/schemas/DocumentRef" }
        error:
          $ref: "#/components/schemas/ErrorResponse"
      required: [shipmentId, status, requestId]

    CancelShipmentResponse:
      type: object
      additionalProperties: false
      properties:
        shipmentId: { type: string }
        status: { $ref: "#/components/schemas/ShipmentStatus" }
        requestId: { type: string }
      required: [shipmentId, status, requestId]

paths:
  /v1/rates/quote:
    post:
      tags: [Rates]
      operationId: quoteRates
      summary: Get shipping options (rates)
      description: >
        Returns a list of shipping options for the given addresses and packages.
      security:
        - FrontendKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/XRequestId"
      x-retry-policy:
        guidance: "If error.retryable=true, retry with backoff. In checkout flows, keep retries low (2â€“3)."
        retryableErrorCodes: [TEMPORARY_CARRIER_FAILURE, UPSTREAM_TIMEOUT, RATE_LIMITED]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/QuoteRequest" }
      responses:
        "200":
          description: OK
          headers:
            X-Request-Id: { $ref: "#/components/headers/XRequestId" }
          content:
            application/json:
              schema: { $ref: "#/components/schemas/QuoteResponse" }
        "401":
          description: Invalid key
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Missing/invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "429":
          description: Too many requests
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "503":
          description: Temporarily unavailable
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "504":
          description: Timeout
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments:
    post:
      tags: [Shipments]
      operationId: createShipment
      summary: Create a shipment
      description: >
        Creates a shipment using a selected rate from a previous quote.
        If addresses or packages changed since the quote, the request will fail.
      security:
        - BackendKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - $ref: "#/components/parameters/IdempotencyKey"
      x-retry-policy:
        guidance: "Retry only when error.retryable=true, and always reuse the same Idempotency-Key."
        retryableErrorCodes: [TEMPORARY_CARRIER_FAILURE, UPSTREAM_TIMEOUT, RATE_LIMITED]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ShipmentCreateRequest" }
      responses:
        "201":
          description: Created (READY or PROCESSING)
          headers:
            X-Request-Id: { $ref: "#/components/headers/XRequestId" }
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShipmentResponse" }
        "202":
          description: Accepted (PROCESSING)
          headers:
            X-Request-Id: { $ref: "#/components/headers/XRequestId" }
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShipmentResponse" }
        "401":
          description: Invalid key
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Missing/invalid input, customs required, or selection mismatch/expired
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                selectionMismatch:
                  value:
                    error:
                      code: SELECTION_MISMATCH
                      message: "The shipment details changed since the selected rate. Request a new quote."
                      retryable: false
                      requestId: "req_01HZMM"
                customsRequired:
                  value:
                    error:
                      code: CUSTOMS_REQUIRED
                      message: "Customs/registration details are required for this shipment."
                      retryable: false
                      requestId: "req_01HZCUST"
        "409":
          description: Conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "503":
          description: Temporarily unavailable
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "504":
          description: Timeout
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments/{shipmentId}:
    get:
      tags: [Shipments]
      operationId: getShipment
      summary: Get shipment status
      description: Returns the current shipment status and any available documents.
      security:
        - BackendKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - name: shipmentId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          headers:
            X-Request-Id: { $ref: "#/components/headers/XRequestId" }
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ShipmentResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments/{shipmentId}/documents:
    get:
      tags: [Documents]
      operationId: listDocuments
      summary: List shipment documents
      description: Returns download links for shipment documents (labels, invoices, etc.).
      security:
        - BackendKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - name: shipmentId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          headers:
            X-Request-Id: { $ref: "#/components/headers/XRequestId" }
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  shipmentId: { type: string }
                  requestId: { type: string }
                  documents:
                    type: array
                    items: { $ref: "#/components/schemas/DocumentRef" }
                required: [shipmentId, requestId, documents]
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/shipments/{shipmentId}/cancel:
    post:
      tags: [Shipments]
      operationId: cancelShipment
      summary: Cancel a shipment
      description: Cancels a shipment if possible.
      security:
        - BackendKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - name: shipmentId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          headers:
            X-Request-Id: { $ref: "#/components/headers/XRequestId" }
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CancelShipmentResponse" }
        "409":
          description: Cannot cancel (already processed/shipped)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

